<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=300">
    <title>Woordklok Instellingen</title>
    <link rel="stylesheet" href="index.css">
</head>
<body onload="loadSettings();">

    <script src="jscolor.js"></script>

    <div class="header">Woordklok Instellingen</div>

    <div class="outer_frame">
        <p>Weergave</p>
        <div class="buttondiv">
            <button id="foregroundColorButton"
                    class="colorbutton jscolor {width:150,onFineChange:'newForeground=this.toString()',valueElement:null,value:'ffffff'}">
                wordt geladen...
            </button>
        </div>

        <div class="buttondiv">
            <button id="backgroundColorButton"
                    class="colorbutton jscolor {width:150,onFineChange:'newBackground=this.toString()',valueElement:null,value:'000000'}">
                wordt geladen...
            </button>
        </div>

        <div class="buttondiv">
            <button id="secondsColorButton"
                    class="colorbutton jscolor {width:150,onFineChange:'newSeconds=this.toString()',valueElement:null,value:'400020'}">
                wordt geladen...
            </button>
        </div>
        <div class="slidediv">
            Helderheid  <input type="range" min="0" max="255" value="125" name="brightness" id="brightness" onchange="brightnessChanged(this.value)" />
        </div>
        Effect
        <select name="displaymode" id="displaymode" class="transitions" onchange="displayModeChanged()">
            <option>Simpel</option>
            <option>Zachte overgangen</option>
            <option>Letters die naar boven vliegen</option>
            <option>Letters die naar beneden vallen</option>
            <option>Exploderende letters</option>
            <option>Plasma</option>
            <option>The Matrix</option>
            <option>Heart</option>>
            <option>Fire</option>
            <option>Stars</option>
            <option>Willekeurig</option>
            <option>Horizontale Strepen</option>
            <option>Verticale Strepen</option>
            <option>Willekeurige stippen</option>
            <option>Willekeurige strepen</option>
            <option>Draaiende lijn</option>
            <option>Kerst</option>
        </select><br />
        <div class="slidediv">
            Snelheid<input type="range" min="1" max="100" value="50" name="animspeed" id="animspeed" onchange="animspeedChanged(this.value)" />
        </div>
        <label>Nachtstand<input type="checkbox" name="nachtmodus" id="nightmode" onchange="nightmodeEnableChanged()"></label>
    </div>


    <div class="outer_frame">
        Alarmen<br />
        <input type="time" value="12:00" name="a0time" id="a0time" class="time" onchange="alarmChanged(0)" />
        <select name="a0mode" id="a0mode" class="alarmmode" onchange="alarmChanged(0)">
            <option>stars</option>
            <option>matrix</option>
            <option>plasma</option>
            <option>fire</option>
            <option>heart</option>
            <option>wakeup</option>
        </select>
        <input type="number" value="1" name="a0duration" id="a0duration" min="0" max="60" class="duration" onchange="alarmChanged(0)" />
        <select name="a0type" id="a0type" class="alarmmode" onchange="alarmChanged(0)">
            <option>Eenmalig</option>
            <option>Altijd</option>
            <option>Weekend</option>
            <option>Werkdagen</option>
        </select>
        <input type="checkbox" name="a0enabled" id="a0enabled" onchange="alarmChanged(0)">
        <br />
        <input type="time" value="12:00" name="a1time" id="a1time" class="time" onchange="alarmChanged(1)" />
        <select name="a1mode" id="a1mode" class="alarmmode" onchange="alarmChanged(1)">
            <option>stars</option>
            <option>matrix</option>
            <option>plasma</option>
            <option>fire</option>
            <option>heart</option>
            <option>wakeup</option>
        </select>
        <input type="number" value="1" name="a1duration" id="a1duration" min="0" max="60" class="duration" onchange="alarmChanged(1)" />
        <select name="a1type" id="a1type" class="alarmmode" onchange="alarmChanged(1)">
            <option>Eenmalig</option>
            <option>Altijd</option>
            <option>Weekend</option>
            <option>Werkdagen</option>
        </select>
        <input type="checkbox" name="a1enabled" id="a1enabled" onchange="alarmChanged(1)">
        <br />
        <input type="time" value="12:00" name="a2time" id="a2time" class="time" onchange="alarmChanged(2)" />
        <select name="a2mode" id="a2mode" class="alarmmode" onchange="alarmChanged(2)">
            <option>stars</option>
            <option>matrix</option>
            <option>plasma</option>
            <option>fire</option>
            <option>heart</option>
            <option>wakeup</option>
        </select>
        <input type="number" value="1" name="a2duration" id="a2duration" min="0" max="60" class="duration" onchange="alarmChanged(2)" />
        <select name="a2type" id="a2type" class="alarmmode" onchange="alarmChanged(2)">
            <option>Eenmalig</option>
            <option>Altijd</option>
            <option>Weekend</option>
            <option>Werkdagen</option>
        </select>
        <input type="checkbox" name="a2enabled" id="a2enabled" onchange="alarmChanged(2)">
        <br />
        <input type="time" value="12:00" name="a3time" id="a3time" class="time" onchange="alarmChanged(3)" />
        <select name="a3mode" id="a3mode" class="alarmmode" onchange="alarmChanged(3)">
            <option>stars</option>
            <option>matrix</option>
            <option>plasma</option>
            <option>fire</option>
            <option>heart</option>
            <option>wakeup</option>
        </select>
        <input type="number" value="1" name="a3duration" id="a3duration" min="0" max="60" class="duration" onchange="alarmChanged(3)" />
        <select name="a3type" id="a3type" class="alarmmode" onchange="alarmChanged(3)">
            <option>Eenmalig</option>
            <option>Altijd</option>
            <option>Weekend</option>
            <option>Werkdagen</option>
        </select>
        <input type="checkbox" name="a3enabled" id="a3enabled" onchange="alarmChanged(3)">
        <br />
        <input type="time" value="12:00" name="a4time" id="a4time" class="time" onchange="alarmChanged(4)" />
        <select name="a4mode" id="a4mode" class="alarmmode" onchange="alarmChanged(4)">
            <option>stars</option>
            <option>matrix</option>
            <option>plasma</option>
            <option>fire</option>
            <option>heart</option>
            <option>wakeup</option>
        </select>
        <input type="number" value="1" name="a4duration" id="a4duration" min="0" max="60" class="duration" onchange="alarmChanged(4)" />
        <select name="a4type" id="a4type" class="alarmmode" onchange="alarmChanged(4)">
            <option>Eenmalig</option>
            <option>Altijd</option>
            <option>Weekend</option>
            <option>Werkdagen</option>
        </select>
        <input type="checkbox" name="a4enabled" id="a4enabled" onchange="alarmChanged(4)">
        <br />

    </div>


    <div class="outer_frame">
        <p>Runtime opties</p><br />
        Tijdzone
        <select name="timezone" id="timezone" onchange="timeZoneChanged()">
            <option>UTC-12:00</option>
            <option>UTC-11:00</option>
            <option>UTC-10:00</option>
            <option>UTC-09:00</option>
            <option>UTC-08:00</option>
            <option>UTC-07:00</option>
            <option>UTC-06:00</option>
            <option>UTC-05:00</option>
            <option>UTC-04:00</option>
            <option>UTC-03:00</option>
            <option>UTC-02:00</option>
            <option>UTC-01:00</option>
            <option>UTC+00:00</option>
            <option>UTC+01:00</option>
            <option>UTC+02:00</option>
            <option>UTC+03:00</option>
            <option>UTC+04:00</option>
            <option>UTC+05:00</option>
            <option>UTC+06:00</option>
            <option>UTC+07:00</option>
            <option>UTC+08:00</option>
            <option>UTC+09:00</option>
            <option>UTC+10:00</option>
            <option>UTC+11:00</option>
            <option>UTC+12:00</option>
            <option>UTC+13:00</option>
            <option>UTC+14:00</option>
        </select><br />
        <label><input type="checkbox" name="heartbeat" id="heartbeat" onchange="heartbeatEnableChanged()">Hartslag</label><br />
    </div>

    <div class="outer_frame">
        <p>Config</p><br />
        Hostname
        <input type="text" class="hn_input" id="hostname" size="10" value="wordt geladen..." onClick="this.setSelectionRange(0, this.value.length)">
        <br />
        NTPserver
        <input type="text" class="ntpinput" id="ntpserver" size="10" value="wordt geladen..." onClick="this.setSelectionRange(0, this.value.length)"><br />
        <label><input type="checkbox" name="mqttenabled" id="mqttenabled" onchange="onmqttenabledchanged()">MQTT</label>
        <br />Server <input type="text" class="hn_input" id="mqttserver" size="10" value="Loading..." onClick="this.setSelectionRange(0, this.value.length)" disabled><br />
        Port <input type="number" class="port_input" id="mqttport" size="10" onClick="this.setSelectionRange(0, this.value.length)" disabled><br />
        <label><input type="checkbox" name="usemqttauthentication" id="usemqttauthentication" onchange="onusemqttauthenticationchanged()" disabled>Use Authentication</label><br />
        Username <input type="text" class="user_input" id="mqttuser" size="10" value="Loading..." onClick="this.setSelectionRange(0, this.value.length)" disabled><br />
        Password <input type="password" class="user_input" id="mqttpass" size="10" value="Loading..." onClick="this.setSelectionRange(0, this.value.length)" disabled on><br />
        <label><input type="checkbox" name="mqttretained" id="mqttretained" disabled>Retained Messages</label><br /><br />
        <button class="colorbutton" onclick="saveSettings()">Save and Restart</button>
    </div>

    <div class="outer_frame">
        <p>Beheer</p>
        <div class="buttondiv">
            <button class="colorbutton" onclick="reset()">Herstarten</button>
            <button class="colorbutton" onclick="resetWifiCredentials()">reset WiFi configuratie</button>
            <button class="colorbutton" onclick="factoryReset()">herstel fabriekinstellingen</button>
            <a href="upload">Click here to upload files</a>
        </div>
    </div>

    <script>
        var lastBackground = '';
        var newBackground = '';
        var lastForeground = '';
        var newForeground = '';
        var lastSeconds = '';
        var newSeconds = '';

        var timer = setTimeout(sendColorTimer, 250);

        function onmqttenabledchanged() {
            if (document.getElementById('mqttenabled').checked) {
                document.getElementById("mqttserver").disabled = false;
                document.getElementById("mqttport").disabled = false;
                document.getElementById("usemqttauthentication").disabled = false;
                document.getElementById("mqttretained").disabled = false;

                NewValue = true;
                if (document.getElementById('usemqttauthentication').checked) {
                    NewValue = false;
                }
                // adapt fields
                document.getElementById("mqttuser").disabled = NewValue;
                document.getElementById("mqttpass").disabled = NewValue;
            } else {
                document.getElementById("mqttserver").disabled = true;
                document.getElementById("mqttport").disabled = true;
                document.getElementById("usemqttauthentication").disabled = true;
                document.getElementById("mqttretained").disabled = true;
                document.getElementById("mqttuser").disabled = true;
                document.getElementById("mqttpass").disabled = true;
            }
        }

        function onusemqttauthenticationchanged() {
            NewValue = true;
            if (document.getElementById('usemqttauthentication').checked) {
                NewValue = false;
            }
            // adapt fields
            document.getElementById("mqttuser").disabled = NewValue;
            document.getElementById("mqttpass").disabled = NewValue;
        }

        function heartbeatEnableChanged() {
            var enabled = 0;
            var heartbeatCheckbox = document.getElementById("heartbeat");
            if (heartbeatCheckbox.checked == true) enabled = 1;
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/setheartbeat?value=" + enabled, true);
            xhttp.send();
        }

        function nightmodeEnableChanged() {
            var enabled = 0;
            var heartbeatCheckbox = document.getElementById("nightmode");
            if (heartbeatCheckbox.checked == true) enabled = 1;
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/setnightmode?value=" + enabled, true);
            xhttp.send();
        }

        function displayModeChanged() {
            var displayModeCombo = document.getElementById("displaymode");
            var newMode = displayModeCombo.selectedIndex;
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/setmode?value=" + newMode, true);
            xhttp.send();
        }

        function timeZoneChanged() {
            var newTimeZone;
            var timeZoneCombo = document.getElementById("timezone");
            switch (timeZoneCombo.selectedIndex) {
                case 0:
                    newTimeZone = -12; break;
                case 1:
                    newTimeZone = -11; break;
                case 2:
                    newTimeZone = -10; break;
                case 3:
                    newTimeZone = -9; break;
                case 4:
                    newTimeZone = -8; break;
                case 5:
                    newTimeZone = -7; break;
                case 6:
                    newTimeZone = -6; break;
                case 7:
                    newTimeZone = -5; break;
                case 8:
                    newTimeZone = -4; break;
                case 9:
                    newTimeZone = -3; break;
                case 10:
                    newTimeZone = -2; break;
                case 11:
                    newTimeZone = -1; break;
                case 12:
                    newTimeZone = 0; break;
                case 13:
                    newTimeZone = 1; break;
                case 14:
                    newTimeZone = 2; break;
                case 15:
                    newTimeZone = 3; break;
                case 16:
                    newTimeZone = 4; break;
                case 17:
                    newTimeZone = 5; break;
                case 18:
                    newTimeZone = 6; break;
                case 19:
                    newTimeZone = 7; break;
                case 20:
                    newTimeZone = 8; break;
                case 21:
                    newTimeZone = 9; break;
                case 22:
                    newTimeZone = 10; break;
                case 23:
                    newTimeZone = 11; break;
                case 24:
                    newTimeZone = 12; break;
                case 25:
                    newTimeZone = 13; break;
                case 26:
                    newTimeZone = 14; break;
                default:
                    newTimeZone = 0;
                    break;
            }
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/settimezone?value=" + newTimeZone, true);
            xhttp.send();
        }

        function updateButton(id, text, r, g, b) {
            button = document.getElementById(id);
            button.jscolor.fromRGB(r, g, b);
            button.innerHTML = text;
            return button.jscolor.toString();
        }

        function loadConfig() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState == 4 && xhttp.status == 200) {
                    console.log("received " + xhttp.responseText);
                    const json = JSON.parse(xhttp.responseText);
                    newBackground = updateButton('backgroundColorButton', 'Achtergrond', json.backgroundcolor.r, json.backgroundcolor.g, json.backgroundcolor.b);
                    newForeground = updateButton('foregroundColorButton', 'Voorgrond', json.foregroundcolor.r, json.foregroundcolor.g, json.foregroundcolor.b);
                    newSeconds = updateButton('secondsColorButton', 'Seconden', json.secondscolor.r, json.secondscolor.g, json.secondscolor.b);
                    lastBackground = newBackground;
                    lastForeground = newForeground;
                    lastSeconds = newSeconds;

                    document.getElementById('ntpserver').value = json.NTPServer;
                    document.getElementById('hostname').value = json.hostname;
                    document.getElementById('displaymode').selectedIndex = json.displaymode;
                    document.getElementById('heartbeat').checked = json.heartbeat;
                    document.getElementById('nightmode').checked = json.nightmode;
                    document.getElementById('timezone').selectedIndex = json.timezone + 12;
                    document.getElementById('brightness').value = json.Brightness;
                    document.getElementById('animspeed').value = json.animspeed;

                    // get mqtt config
                    document.getElementById('mqttenabled').checked = json.usemqtt;
                    document.getElementById('mqttserver').value = json.mqttserver;
                    document.getElementById('mqttport').value = +json.mqttport;
                    document.getElementById('usemqttauthentication').checked = json.usemqttauthentication;
                    document.getElementById('mqttuser').value = json.mqttuser;
                    document.getElementById('mqttpass').value = json.mqttpass;
                    document.getElementById('mqttretained').checked = json.mqttretained;
                    onmqttenabledchanged(); // enable the correct fields

                    for (let i = 0; i < 5; i++) {
                        document.getElementById('a' + i.toString() + 'time').value = json.Alarm[i].time;
                        document.getElementById('a' + i.toString() + 'duration').value = json.Alarm[i].duration;
                        document.getElementById('a' + i.toString() + 'mode').value = json.Alarm[i].mode;
                        document.getElementById('a' + i.toString() + 'enabled').checked = json.Alarm[i].enabled;
                        document.getElementById('a' + i.toString() + 'type').value = json.Alarm[i].type;
                    }
                }
            };
            xhttp.open("GET", "http://" + location.hostname + "/getconfig", true);
            xhttp.send();
        }

        function sendColorTimer() {
            var update = false;
            if (newBackground != '' && newBackground != lastBackground) {
                lastBackground = newBackground;
                update = true;
            }
            if (newForeground != '' && newForeground != lastForeground) {
                lastForeground = newForeground;
                update = true;
            }
            if (newSeconds != '' && newSeconds != lastSeconds) {
                lastSeconds = newSeconds;
                update = true;
            }

            if (newSeconds == '' || newBackground == '' || newForeground == '') {
                update = false;
            }

            if (update == true) {
                var request = "http://" + location.hostname + "/setcolor?"
                    + "bg=" + newBackground
                    + "&fg=" + newForeground
                    + "&s=" + newSeconds;
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", request, true);
                xhttp.send();
            }

            timer = setTimeout(sendColorTimer, 250);
        }

        function isValidIP(ip) {
            var s = ip.split('.');
            if (s.length != 4) return false;
            for (var i = 0; i < 3; i++) {
                if (s[i] == '') return false;
                if (isNaN(s[i])) return false;
                var n = parseInt(s[i]);
                if (n < 0 || n > 255) return false;
            }
            return true;
        }

        function saveSettings() {
            var server = document.getElementById('ntpserver').value;
            // var hostname = document.getElementById('hostname').value;

            if (!isValidIP(document.getElementById('ntpserver').value)) {
                alert("Ongeldig IP Adres voor NTP Server!");
                return;
            }
            if (!isValidIP(document.getElementById('mqttserver').value)) {
                alert("Ongeldig IP Adres voor MQTT Server!");
                return;
            }

            // Sending and receiving data in JSON format using POST method
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "http://" + location.hostname + "/saveconfig", true);
            xhttp.setRequestHeader("Content-Type", "application/json");
            xhttp.onreadystatechange = function () {
                if (xhttp.readyState === 4 && xhttp.status === 200) {
                    alert("Config verzonden. Klok is aan het herstarten")
                } else {
                    if (xhttp.readyState === 4) {
                        alert("some error sending the config (" + xhttp.status + ")");
                    }
                }
            };
            var obj = new Object();
            obj.ntpserver = document.getElementById('ntpserver').value;
            obj.hostname = document.getElementById('hostname').value;
            obj.usemqtt = document.getElementById('mqttenabled').checked;
            obj.mqttserver = document.getElementById('mqttserver').value;
            obj.mqttport = +document.getElementById('mqttport').value;
            obj.mqttuser = document.getElementById('mqttuser').value;
            obj.mqttpass = document.getElementById('mqttpass').value;
            obj.mqttretained = document.getElementById('mqttretained').checked;
            obj.usemqttauthentication = document.getElementById('usemqttauthentication').checked;

            var data = JSON.stringify(obj);
            xhttp.send(data);
        }

        function reset() {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/reset", true);
            xhttp.send();
        }

        function resetWifiCredentials() {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/resetwificredentials", true);
            xhttp.send();
        }

        function factoryReset() {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/factoryreset", true);
            xhttp.send();
        }

        function brightnessChanged(slidevalue) {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/setbrightness?value=" + slidevalue, true);
            xhttp.send();
        }

        function animspeedChanged(slidevalue) {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "http://" + location.hostname + "/setanimspeed?value=" + slidevalue, true);
            xhttp.send();
        }

        function alarmChanged(index) {
            var xhttp = new XMLHttpRequest();
            var time = document.getElementById('a' + index.toString() + 'time').value;
            var mode = document.getElementById('a' + index.toString() + 'mode').value;
            var type = document.getElementById('a' + index.toString() + 'type').value;
            var duration = document.getElementById('a' + index.toString() + 'duration').value;
            var enabled = "off";
            if (document.getElementById('a' + index.toString() + 'enabled').checked == true) enabled = "on";
            xhttp.open("GET", "http://" + location.hostname + "/setalarm?number=" + index.toString() + "&time=" + time + "&mode=" + mode + "&enabled=" + enabled + "&duration=" + duration + "&type=" + type, true);
            xhttp.send();
        }

        function loadSettings() {
            loadConfig();
        }
    </script>
</body>
</html>